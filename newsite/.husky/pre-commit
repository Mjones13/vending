#!/bin/sh
# Pre-commit hook for Golden Coast Amenities website
# Runs automated tests before allowing commits for code changes
# Skips tests for documentation/configuration-only changes

echo "ğŸ” Running pre-commit checks..."

# Change to the correct directory
cd newsite 2>/dev/null || {
  echo "âœ“ Already in newsite directory"
}

# Check if we're in a Next.js project
if [ ! -f "package.json" ] || ! grep -q "next" package.json; then
  echo "âŒ Error: Not in a Next.js project directory"
  echo "Make sure you're in the newsite/ directory"
  exit 1
fi

# Check if this commit contains only non-code files
# Non-code files: documentation (.md), config files, CLAUDE.md, directory structure
git diff --cached --name-only | grep -E '\.(js|jsx|ts|tsx|css|scss|sass|json)$|pages/|components/|hooks/|styles/.*\.(css|scss|sass)$' > /dev/null
HAS_CODE_CHANGES=$?

if [ $HAS_CODE_CHANGES -ne 0 ]; then
  echo "ğŸ“ Documentation/configuration-only changes detected"
  echo "â­ï¸  Skipping test suite for non-code changes"
  echo "âœ… Pre-commit checks completed for documentation changes!"
  echo "ğŸš€ Proceeding with commit..."
  exit 0
fi

echo "ğŸ’» Code changes detected - running full test suite..."

echo "ğŸ“¦ Installing dependencies if needed..."
npm ci --silent || {
  echo "âŒ Failed to install dependencies"
  exit 1
}

echo "ğŸ§ª Running unit tests..."
npm test -- --watchAll=false --passWithNoTests || {
  echo "âŒ Unit tests failed. Fix tests before committing."
  exit 1
}

echo "ğŸ”§ Running linter..."
npm run lint || {
  echo "âŒ Linting failed. Fix ESLint errors before committing."
  exit 1
}

echo "ğŸ—ï¸  Testing build..."
npm run build || {
  echo "âŒ Build failed. Fix build errors before committing."
  exit 1
}

echo "âœ… All pre-commit checks passed!"
echo "ğŸš€ Proceeding with commit..."